@page "/admin/skills"
@layout AdminLayout
@using Application.Skills.Queries.DTOs
@using Domain.Enums
@inject ISkillsService SkillsService
@inject NavigationManager NavigationManager

<PageTitle>Manage Skills</PageTitle>

<div class="admin-page">
    <div class="admin-page-header">
        <div>
            <h1 class="admin-page-title">Skills</h1>
            <p class="admin-page-subtitle">Manage your technical skills</p>
        </div>
        <button class="btn btn-primary" @onclick="NavigateToCreate">
            <i class="bi bi-plus-circle"></i> Add New Skill
        </button>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading skills...</p>
        </div>
    }
    else if (!skills.Any())
    {
        <div class="empty-state">
            <i class="bi bi-star"></i>
            <h3>No skills yet</h3>
            <p>Get started by adding your first skill</p>
            <button class="btn btn-primary mt-3" @onclick="NavigateToCreate">
                <i class="bi bi-plus-circle"></i> Add Skill
            </button>
        </div>
    }
    else
    {
        @foreach (var category in Enum.GetValues<SkillCategory>())
        {
            var categorySkills = skills.Where(s => s.Category == category).OrderBy(s => s.DisplayOrder).ToList();
            if (categorySkills.Any())
            {
                <div class="mb-4">
                    <h3 class="mb-3">@GetCategoryName(category)</h3>
                    <div class="table-responsive">
                        <table class="table table-hover admin-table">
                            <thead>
                                <tr>
                                    <th>Order</th>
                                    <th>Name</th>
                                    <th>Icon URL</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var skill in categorySkills)
                                {
                                    <tr>
                                        <td>
                                            <span class="badge bg-secondary">@skill.DisplayOrder</span>
                                        </td>
                                        <td>
                                            <strong>@skill.Name</strong>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(skill.IconUrl))
                                            {
                                                <small class="text-muted">@skill.IconUrl</small>
                                            }
                                            else
                                            {
                                                <small class="text-muted">-</small>
                                            }
                                        </td>
                                        <td class="text-end">
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" @onclick="() => NavigateToEdit(skill.Id)" title="Edit">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" @onclick="() => ConfirmDelete(skill.Id)" title="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
        }
    }
</div>

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirm)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" @onclick="CancelDelete"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this skill?</p>
                    <p class="text-muted mb-0"><strong>@skillToDelete?.Name</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelDelete" disabled="@isDeleting">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="HandleDelete" disabled="@isDeleting">
                        @if (isDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Deleting...</span>
                        }
                        else
                        {
                            <span>Delete</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<SkillDto> skills = new();
    private bool isLoading = true;
    private bool showDeleteConfirm = false;
    private bool isDeleting = false;
    private SkillDto? skillToDelete = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadSkills();
    }

    private async Task LoadSkills()
    {
        isLoading = true;
        skills = await SkillsService.GetAllSkillsAsync();
        isLoading = false;
    }

    private void NavigateToCreate()
    {
        NavigationManager.NavigateTo("/admin/skills/create");
    }

    private void NavigateToEdit(int id)
    {
        NavigationManager.NavigateTo($"/admin/skills/edit/{id}");
    }

    private void ConfirmDelete(int id)
    {
        skillToDelete = skills.FirstOrDefault(s => s.Id == id);
        if (skillToDelete != null)
        {
            showDeleteConfirm = true;
        }
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
        skillToDelete = null;
    }

    private async Task HandleDelete()
    {
        if (skillToDelete == null) return;

        isDeleting = true;
        var success = await SkillsService.DeleteSkillAsync(skillToDelete.Id);

        if (success)
        {
            showDeleteConfirm = false;
            skillToDelete = null;
            await LoadSkills();
        }
        else
        {
            Console.WriteLine("Failed to delete skill");
        }

        isDeleting = false;
    }

    private string GetCategoryName(SkillCategory category)
    {
        return category switch
        {
            SkillCategory.Language => "Programming Languages",
            SkillCategory.Framework => "Frameworks & Libraries",
            SkillCategory.Cloud => "Cloud Platforms",
            SkillCategory.Architecture => "Architecture & Patterns",
            SkillCategory.Practice => "Development Practices",
            SkillCategory.Domain => "Domain Knowledge",
            _ => category.ToString()
        };
    }
}
