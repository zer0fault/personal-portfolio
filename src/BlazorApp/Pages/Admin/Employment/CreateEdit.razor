@page "/admin/employment/create"
@page "/admin/employment/edit/{id:int}"
@layout AdminLayout
@using Application.Employment.Queries.DTOs
@using Application.Employment.Commands.CreateEmployment
@using Application.Employment.Commands.UpdateEmployment
@using System.ComponentModel.DataAnnotations
@inject IEmploymentService EmploymentService
@inject NavigationManager NavigationManager

<PageTitle>@(IsEditMode ? "Edit Employment" : "Add Employment")</PageTitle>

<div class="admin-page">
    <div class="admin-page-header">
        <div>
            <h1 class="admin-page-title">@(IsEditMode ? "Edit Employment" : "Add New Employment")</h1>
            <p class="admin-page-subtitle">@(IsEditMode ? "Update employment details" : "Add a new position to your work history")</p>
        </div>
        <button class="btn btn-outline-secondary" @onclick="NavigateBack">
            <i class="bi bi-arrow-left"></i> Back to Employment
        </button>
    </div>

    @if (isLoading && IsEditMode)
    {
        <div class="loading-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading employment entry...</p>
        </div>
    }
    else
    {
        <div class="form-container">
            <EditForm Model="@model" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> @errorMessage
                    </div>
                }

                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">Position Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Company Name <span class="text-danger">*</span></label>
                                        <InputText @bind-Value="model.CompanyName" class="form-control" placeholder="Company name" />
                                        <ValidationMessage For="@(() => model.CompanyName)" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Job Title <span class="text-danger">*</span></label>
                                        <InputText @bind-Value="model.JobTitle" class="form-control" placeholder="Job title" />
                                        <ValidationMessage For="@(() => model.JobTitle)" />
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Start Date <span class="text-danger">*</span></label>
                                        <InputDate @bind-Value="model.StartDate" class="form-control" />
                                        <ValidationMessage For="@(() => model.StartDate)" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">End Date</label>
                                        <InputDate @bind-Value="model.EndDate" class="form-control" />
                                        <small class="text-muted">Leave blank if current position</small>
                                        <ValidationMessage For="@(() => model.EndDate)" />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Responsibilities</label>
                                    <InputTextArea @bind-Value="responsibilitiesInput" class="form-control" rows="4"
                                                   placeholder="Enter responsibilities separated by new lines" />
                                    <small class="text-muted">Each line will be a separate responsibility</small>
                                    @if (model.Responsibilities.Any())
                                    {
                                        <div class="mt-2">
                                            <strong>Preview:</strong>
                                            <ul class="mb-0">
                                                @foreach (var resp in model.Responsibilities)
                                                {
                                                    <li>@resp</li>
                                                }
                                            </ul>
                                        </div>
                                    }
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Achievements</label>
                                    <InputTextArea @bind-Value="achievementsInput" class="form-control" rows="4"
                                                   placeholder="Enter achievements separated by new lines" />
                                    <small class="text-muted">Each line will be a separate achievement</small>
                                    @if (model.Achievements.Any())
                                    {
                                        <div class="mt-2">
                                            <strong>Preview:</strong>
                                            <ul class="mb-0">
                                                @foreach (var ach in model.Achievements)
                                                {
                                                    <li>@ach</li>
                                                }
                                            </ul>
                                        </div>
                                    }
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Technologies</label>
                                    <InputText @bind-Value="technologiesInput" class="form-control"
                                               placeholder="Enter technologies separated by commas (e.g., C#, .NET, Azure)" />
                                    <small class="text-muted">Separate multiple technologies with commas</small>
                                    @if (model.Technologies.Any())
                                    {
                                        <div class="tech-tags mt-2">
                                            @foreach (var tech in model.Technologies)
                                            {
                                                <span class="tech-tag-small">@tech</span>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">Settings</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Display Order</label>
                                    <InputNumber @bind-Value="model.DisplayOrder" class="form-control" min="0" />
                                    <small class="text-muted">Lower numbers appear first (most recent)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Saving...</span>
                        }
                        else
                        {
                            <i class="bi bi-save"></i>
                            <span>@(IsEditMode ? "Update Employment" : "Add Employment")</span>
                        }
                    </button>
                    <button type="button" class="btn btn-outline-secondary" @onclick="NavigateBack" disabled="@isSaving">
                        Cancel
                    </button>
                </div>
            </EditForm>
        </div>
    }
</div>

@code {
    [Parameter]
    public int? Id { get; set; }

    private EmploymentFormModel model = new();
    private string responsibilitiesInput = string.Empty;
    private string achievementsInput = string.Empty;
    private string technologiesInput = string.Empty;
    private bool isLoading = false;
    private bool isSaving = false;
    private string errorMessage = string.Empty;

    private bool IsEditMode => Id.HasValue && Id.Value > 0;

    protected override async Task OnInitializedAsync()
    {
        if (IsEditMode)
        {
            await LoadEmployment();
        }
    }

    protected override void OnParametersSet()
    {
        // Update inputs when model changes
        responsibilitiesInput = string.Join("\n", model.Responsibilities);
        achievementsInput = string.Join("\n", model.Achievements);
        technologiesInput = string.Join(", ", model.Technologies);
    }

    private async Task LoadEmployment()
    {
        isLoading = true;
        var employment = await EmploymentService.GetEmploymentByIdAsync(Id!.Value);

        if (employment == null)
        {
            errorMessage = "Employment entry not found";
            isLoading = false;
            return;
        }

        model.CompanyName = employment.CompanyName;
        model.JobTitle = employment.JobTitle;
        model.StartDate = employment.StartDate;
        model.EndDate = employment.EndDate;
        model.Responsibilities = employment.Responsibilities.ToList();
        model.Achievements = employment.Achievements.ToList();
        model.Technologies = employment.Technologies.ToList();
        model.DisplayOrder = employment.DisplayOrder;

        responsibilitiesInput = string.Join("\n", model.Responsibilities);
        achievementsInput = string.Join("\n", model.Achievements);
        technologiesInput = string.Join(", ", model.Technologies);
        isLoading = false;
    }

    private void UpdateLists()
    {
        // Update responsibilities
        if (!string.IsNullOrWhiteSpace(responsibilitiesInput))
        {
            model.Responsibilities = responsibilitiesInput
                .Split('\n')
                .Select(r => r.Trim())
                .Where(r => !string.IsNullOrWhiteSpace(r))
                .ToList();
        }
        else
        {
            model.Responsibilities.Clear();
        }

        // Update achievements
        if (!string.IsNullOrWhiteSpace(achievementsInput))
        {
            model.Achievements = achievementsInput
                .Split('\n')
                .Select(a => a.Trim())
                .Where(a => !string.IsNullOrWhiteSpace(a))
                .ToList();
        }
        else
        {
            model.Achievements.Clear();
        }

        // Update technologies
        if (!string.IsNullOrWhiteSpace(technologiesInput))
        {
            model.Technologies = technologiesInput
                .Split(',')
                .Select(t => t.Trim())
                .Where(t => !string.IsNullOrWhiteSpace(t))
                .ToList();
        }
        else
        {
            model.Technologies.Clear();
        }
    }

    private async Task HandleSubmit()
    {
        errorMessage = string.Empty;
        isSaving = true;

        // Update lists from inputs
        UpdateLists();

        try
        {
            if (IsEditMode)
            {
                var command = new UpdateEmploymentCommand
                {
                    Id = Id!.Value,
                    CompanyName = model.CompanyName,
                    JobTitle = model.JobTitle,
                    StartDate = model.StartDate,
                    EndDate = model.EndDate,
                    Responsibilities = model.Responsibilities,
                    Achievements = model.Achievements,
                    Technologies = model.Technologies,
                    DisplayOrder = model.DisplayOrder
                };

                var success = await EmploymentService.UpdateEmploymentAsync(command);
                if (success)
                {
                    NavigateBack();
                }
                else
                {
                    errorMessage = "Failed to update employment entry. Please try again.";
                }
            }
            else
            {
                var command = new CreateEmploymentCommand
                {
                    CompanyName = model.CompanyName,
                    JobTitle = model.JobTitle,
                    StartDate = model.StartDate,
                    EndDate = model.EndDate,
                    Responsibilities = model.Responsibilities,
                    Achievements = model.Achievements,
                    Technologies = model.Technologies,
                    DisplayOrder = model.DisplayOrder
                };

                var employmentId = await EmploymentService.CreateEmploymentAsync(command);
                if (employmentId.HasValue)
                {
                    NavigateBack();
                }
                else
                {
                    errorMessage = "Failed to create employment entry. Please try again.";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
            Console.WriteLine($"Error saving employment: {ex}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void NavigateBack()
    {
        NavigationManager.NavigateTo("/admin/employment");
    }

    public class EmploymentFormModel
    {
        [Required(ErrorMessage = "Company name is required")]
        [StringLength(200, ErrorMessage = "Company name cannot exceed 200 characters")]
        public string CompanyName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Job title is required")]
        [StringLength(200, ErrorMessage = "Job title cannot exceed 200 characters")]
        public string JobTitle { get; set; } = string.Empty;

        [Required(ErrorMessage = "Start date is required")]
        public DateTime StartDate { get; set; } = DateTime.Today;

        public DateTime? EndDate { get; set; }

        public List<string> Responsibilities { get; set; } = new();
        public List<string> Achievements { get; set; } = new();
        public List<string> Technologies { get; set; } = new();

        [Range(0, int.MaxValue, ErrorMessage = "Display order must be a positive number")]
        public int DisplayOrder { get; set; }
    }
}
