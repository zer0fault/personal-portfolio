@page "/admin/employment"
@layout AdminLayout
@using Application.Employment.Queries.DTOs
@inject IEmploymentService EmploymentService
@inject NavigationManager NavigationManager

<PageTitle>Manage Employment</PageTitle>

<div class="admin-page">
    <div class="admin-page-header">
        <div>
            <h1 class="admin-page-title">Employment History</h1>
            <p class="admin-page-subtitle">Manage your work experience</p>
        </div>
        <button class="btn btn-primary" @onclick="NavigateToCreate">
            <i class="bi bi-plus-circle"></i> Add New Position
        </button>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading employment history...</p>
        </div>
    }
    else if (!employment.Any())
    {
        <div class="empty-state">
            <i class="bi bi-briefcase"></i>
            <h3>No employment history yet</h3>
            <p>Get started by adding your first position</p>
            <button class="btn btn-primary mt-3" @onclick="NavigateToCreate">
                <i class="bi bi-plus-circle"></i> Add Position
            </button>
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover admin-table">
                <thead>
                    <tr>
                        <th>Order</th>
                        <th>Company & Position</th>
                        <th>Duration</th>
                        <th>Technologies</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var emp in employment.OrderBy(e => e.DisplayOrder))
                    {
                        <tr>
                            <td>
                                <span class="badge bg-secondary">@emp.DisplayOrder</span>
                            </td>
                            <td>
                                <strong>@emp.JobTitle</strong>
                                <br />
                                <small class="text-muted">@emp.CompanyName</small>
                            </td>
                            <td>
                                <div>@emp.StartDate.ToString("MMM yyyy") - @(emp.EndDate?.ToString("MMM yyyy") ?? "Present")</div>
                                <small class="text-muted">@GetDuration(emp.StartDate, emp.EndDate)</small>
                            </td>
                            <td>
                                <div class="tech-tags-small">
                                    @foreach (var tech in emp.Technologies.Take(3))
                                    {
                                        <span class="tech-tag-small">@tech</span>
                                    }
                                    @if (emp.Technologies.Count > 3)
                                    {
                                        <span class="tech-tag-small">+@(emp.Technologies.Count - 3)</span>
                                    }
                                </div>
                            </td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" @onclick="() => NavigateToEdit(emp.Id)" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" @onclick="() => ConfirmDelete(emp.Id)" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirm)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" @onclick="CancelDelete"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this employment entry?</p>
                    <p class="text-muted mb-0"><strong>@employmentToDelete?.JobTitle</strong> at @employmentToDelete?.CompanyName</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelDelete" disabled="@isDeleting">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="HandleDelete" disabled="@isDeleting">
                        @if (isDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            <span>Deleting...</span>
                        }
                        else
                        {
                            <span>Delete</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<EmploymentDto> employment = new();
    private bool isLoading = true;
    private bool showDeleteConfirm = false;
    private bool isDeleting = false;
    private EmploymentDto? employmentToDelete = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadEmployment();
    }

    private async Task LoadEmployment()
    {
        isLoading = true;
        employment = await EmploymentService.GetAllEmploymentAsync();
        isLoading = false;
    }

    private void NavigateToCreate()
    {
        NavigationManager.NavigateTo("/admin/employment/create");
    }

    private void NavigateToEdit(int id)
    {
        NavigationManager.NavigateTo($"/admin/employment/edit/{id}");
    }

    private void ConfirmDelete(int id)
    {
        employmentToDelete = employment.FirstOrDefault(e => e.Id == id);
        if (employmentToDelete != null)
        {
            showDeleteConfirm = true;
        }
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
        employmentToDelete = null;
    }

    private async Task HandleDelete()
    {
        if (employmentToDelete == null) return;

        isDeleting = true;
        var success = await EmploymentService.DeleteEmploymentAsync(employmentToDelete.Id);

        if (success)
        {
            showDeleteConfirm = false;
            employmentToDelete = null;
            await LoadEmployment();
        }
        else
        {
            Console.WriteLine("Failed to delete employment entry");
        }

        isDeleting = false;
    }

    private string GetDuration(DateTime startDate, DateTime? endDate)
    {
        var end = endDate ?? DateTime.UtcNow;
        var duration = end - startDate;
        var years = duration.Days / 365;
        var months = (duration.Days % 365) / 30;

        if (years > 0 && months > 0)
            return $"{years} yr{(years > 1 ? "s" : "")} {months} mo{(months > 1 ? "s" : "")}";
        else if (years > 0)
            return $"{years} yr{(years > 1 ? "s" : "")}";
        else if (months > 0)
            return $"{months} mo{(months > 1 ? "s" : "")}";
        else
            return "Less than 1 month";
    }
}
