@inject IContactService ContactService
@using Application.Contact.Commands

<section class="contact-section" id="contact">
    <div class="container">
        <h2 class="section-title">Get In Touch</h2>
        <p class="section-description">
            Have a question or want to work together? Feel free to reach out!
        </p>

        <div class="row justify-content-center">
            <div class="col-lg-8">
                @if (showSuccessMessage)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="bi bi-check-circle-fill"></i>
                        <strong>Thank you!</strong> Your message has been sent successfully. I'll get back to you soon!
                        <button type="button" class="btn-close" @onclick="() => showSuccessMessage = false"></button>
                    </div>
                }

                @if (showErrorMessage)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <strong>Oops!</strong> Something went wrong. Please try again later.
                        <button type="button" class="btn-close" @onclick="() => showErrorMessage = false"></button>
                    </div>
                }

                <div class="contact-form-card">
                    <EditForm Model="contactForm" OnValidSubmit="HandleSubmit">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label for="name" class="form-label">Name <span class="text-danger">*</span></label>
                            <InputText id="name" class="form-control" @bind-Value="contactForm.Name" placeholder="Your name" disabled="@isSubmitting" />
                            <ValidationMessage For="@(() => contactForm.Name)" />
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                            <InputText id="email" type="email" class="form-control" @bind-Value="contactForm.Email" placeholder="your.email@example.com" disabled="@isSubmitting" />
                            <ValidationMessage For="@(() => contactForm.Email)" />
                        </div>

                        <div class="mb-3">
                            <label for="subject" class="form-label">Subject <span class="text-danger">*</span></label>
                            <InputText id="subject" class="form-control" @bind-Value="contactForm.Subject" placeholder="What's this about?" disabled="@isSubmitting" />
                            <ValidationMessage For="@(() => contactForm.Subject)" />
                        </div>

                        <div class="mb-3">
                            <label for="message" class="form-label">Message <span class="text-danger">*</span></label>
                            <InputTextArea id="message" class="form-control" rows="6" @bind-Value="contactForm.Message" placeholder="Your message..." disabled="@isSubmitting" />
                            <ValidationMessage For="@(() => contactForm.Message)" />
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <span>Sending...</span>
                                }
                                else
                                {
                                    <i class="bi bi-send-fill me-2"></i>
                                    <span>Send Message</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</section>

@code {
    private ContactFormModel contactForm = new();
    private bool isSubmitting = false;
    private bool showSuccessMessage = false;
    private bool showErrorMessage = false;

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        showSuccessMessage = false;
        showErrorMessage = false;

        try
        {
            var dto = new ContactSubmissionDto
            {
                Name = contactForm.Name,
                Email = contactForm.Email,
                Subject = contactForm.Subject,
                Message = contactForm.Message
            };

            var success = await ContactService.SubmitContactAsync(dto);

            if (success)
            {
                showSuccessMessage = true;
                contactForm = new ContactFormModel(); // Reset form
            }
            else
            {
                showErrorMessage = true;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error submitting contact form: {ex.Message}");
            showErrorMessage = true;
        }
        finally
        {
            isSubmitting = false;
        }
    }

    public class ContactFormModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Name is required")]
        [System.ComponentModel.DataAnnotations.StringLength(100, ErrorMessage = "Name must be less than 100 characters")]
        public string Name { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Email is required")]
        [System.ComponentModel.DataAnnotations.EmailAddress(ErrorMessage = "Invalid email address")]
        public string Email { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Subject is required")]
        [System.ComponentModel.DataAnnotations.StringLength(200, ErrorMessage = "Subject must be less than 200 characters")]
        public string Subject { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Message is required")]
        [System.ComponentModel.DataAnnotations.StringLength(2000, ErrorMessage = "Message must be less than 2000 characters")]
        [System.ComponentModel.DataAnnotations.MinLength(10, ErrorMessage = "Message must be at least 10 characters")]
        public string Message { get; set; } = string.Empty;
    }
}
